<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    .container {
      display: flex;
      gap: 20px;
    }
    .input-panel, .output-panel {
      flex: 1;
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-panel h2, .output-panel h2 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    #output {
      white-space: pre-wrap;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      font-family: monospace;
      height: 600px;
    }
    .btn-group {
      display: flex;
      margin-top: 15px;
    }
    .field-list {
      margin-top: 20px;
    }
    .field-item {
      background-color: white;
      border-left: 4px solid #3498db;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .description {
      background-color: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      background-color: #eee;
      cursor: pointer;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
    }
    .tab.active {
      background-color: #f9f9f9;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .gas-api-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #e8f4f8;
      border-radius: 8px;
      border: 1px solid #b6d7e4;
    }
    .form-field {
      margin-bottom: 15px;
    }
    .form-field label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-field input[type="text"],
    .form-field textarea,
    .form-field select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .form-field textarea {
      min-height: 100px;
    }
    .radio-group {
      display: flex;
      flex-direction: column;
    }
    .radio-option {
      margin-bottom: 5px;
    }
    .required {
      color: red;
    }
    .submit-btn {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    .submit-btn:hover {
      background-color: #219653;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
  
  <div class="description">
    <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šç”¨ã®CSVãƒã‚¹ã‚¿ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’field_nameã”ã¨ã«JSONã«å¤‰æ›ã—ã¾ã™ã€‚</p>
    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (åˆ—å): <br>
    <code>category_value, category_label, parent_value, parent_label, child_value, child_label, grandchild_value, grandchild_label, field_name, field_type, field_label, required, placeholder, options_json, visible_if, display_order</code></p>
  </div>
  
  <div class="container">
    <div class="input-panel">
      <h2>å…¥åŠ›</h2>
      <div class="input-group">
        <label for="csvFile">CSVãƒã‚¹ã‚¿ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«:</label>
        <input type="file" id="csvFile" accept=".csv">
      </div>
      
      <div class="btn-group">
        <button id="convertBtn">å¤‰æ›</button>
        <button id="downloadBtn" disabled>JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      
      <div class="gas-api-section">
        <h3>Google Apps Scripté€£æº</h3>
        <div class="input-group">
          <label for="gasApiUrl">GAS Web APIã®URL:</label>
          <input type="text" id="gasApiUrl" placeholder="ä¾‹: https://script.google.com/macros/s/...">
        </div>
        <button id="fetchFromGAS">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—</button>
      </div>
      
      <div class="field-list" id="fieldList">
        <h3>æ¤œå‡ºã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</h3>
        <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦å¤‰æ›ã™ã‚‹ã¨ã€ã“ã“ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
    
    <div class="output-panel">
      <h2>å‡ºåŠ›</h2>
      
      <div class="tabs">
        <div class="tab active" data-tab="json">JSONãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div class="tab" data-tab="structure">æ§‹é€ èª¬æ˜</div>
        <div class="tab" data-tab="form">ãƒ•ã‚©ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      </div>
      
      <div class="tab-content active" id="json-tab">
        <div id="output">
          // ã“ã“ã«JSONãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      </div>
      
      <div class="tab-content" id="structure-tab">
        <div class="field-item">
          <h3>ç”Ÿæˆã•ã‚Œã‚‹JSONã®æ§‹é€ </h3>
          <pre>
{
  "field_name1": {              // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
    "field_name": "field_name1",
    "field_type": "text",       // ãƒ†ã‚­ã‚¹ãƒˆã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã€ã‚»ãƒ¬ã‚¯ãƒˆãªã©
    "field_label": "è¡¨ç¤ºå",
    "required": true,           // å¿…é ˆã‹ã©ã†ã‹
    "placeholder": "ä¾‹: å…¥åŠ›ä¾‹",
    "options": [],              // ã‚»ãƒ¬ã‚¯ãƒˆãªã©ã®é¸æŠè‚¢
    "visible_if": "æ¡ä»¶",        // è¡¨ç¤ºæ¡ä»¶
    "display_order": 1,         // è¡¨ç¤ºé †
    "categories": [             // ã‚«ãƒ†ã‚´ãƒªãƒ¼éšå±¤
      {
        "value": "1",
        "label": "ã‚«ãƒ†ã‚´ãƒªãƒ¼A",
        "parents": [
          {
            "value": "1001",
            "label": "è¦ªã‚«ãƒ†ã‚´ãƒªãƒ¼1",
            "children": [
              {
                "value": "1001001",
                "label": "å­ã‚«ãƒ†ã‚´ãƒªãƒ¼1",
                "grandchildren": [
                  {
                    "value": "1001001001",
                    "label": "å­«ã‚«ãƒ†ã‚´ãƒªãƒ¼1"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "field_name2": {
    // åŒæ§˜ã®æ§‹é€ 
  }
}
          </pre>
        </div>
      </div>
      
      <div class="tab-content" id="form-tab">
        <button id="generateForm">ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆ</button>
        <div id="form-container" class="form-container">
          <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * CSVã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹é–¢æ•°
     * @param {string} csvString - CSVãƒ‡ãƒ¼ã‚¿ã®æ–‡å­—åˆ—
     * @returns {Array} - ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
     */
    function parseCSV(csvString) {
      // CSVã‚’è¡Œã”ã¨ã«åˆ†å‰²
      const rows = csvString.trim().split(/\r?\n/);
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆåˆ—åï¼‰ã‚’å–å¾—
      const headers = rows[0].split(',').map(header => header.trim());
      
      // çµæœã‚’æ ¼ç´ã™ã‚‹é…åˆ—
      const result = [];
      
      // 2è¡Œç›®ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      for (let i = 1; i < rows.length; i++) {
        // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (rows[i].trim() === '') continue;
        
        // CSVã®è¡Œã‚’è§£æï¼ˆå¼•ç”¨ç¬¦ã§å›²ã¾ã‚ŒãŸã‚«ãƒ³ãƒã‚’å‡¦ç†ï¼‰
        const values = parseCSVRow(rows[i]);
        const entry = {};
        
        // å„åˆ—ã®å€¤ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
        for (let j = 0; j < headers.length; j++) {
          let value = values[j] ? values[j].trim() : '';
          
          // ç‰¹å®šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã™ã‚‹å‹å¤‰æ›
          if (headers[j] === 'required') {
            value = value.toLowerCase() === 'true';
          } else if (headers[j] === 'options_json' && value) {
            try {
              // JSONæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
              value = JSON.parse(value);
            } catch (e) {
              console.warn(`Failed to parse JSON for options_json: ${value}`);
            }
          }
          
          entry[headers[j]] = value;
        }
        
        result.push(entry);
      }
      
      return result;
    }
    
    /**
     * CSVã®1è¡Œã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹é–¢æ•°ï¼ˆå¼•ç”¨ç¬¦ã§å›²ã¾ã‚ŒãŸã‚«ãƒ³ãƒã‚’å‡¦ç†ï¼‰
     * @param {string} row - CSVã®1è¡Œ
     * @returns {Array} - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã®é…åˆ—
     */
    function parseCSVRow(row) {
      const result = [];
      let inQuotes = false;
      let currentValue = '';
      
      for (let i = 0; i < row.length; i++) {
        const char = row[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(currentValue);
          currentValue = '';
        } else {
          currentValue += char;
        }
      }
      
      // æœ€å¾Œã®å€¤ã‚’è¿½åŠ 
      result.push(currentValue);
      
      return result;
    }
    
    /**
     * field_nameã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹é–¢æ•°
     * @param {Array} data - ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸCSVãƒ‡ãƒ¼ã‚¿
     * @returns {Object} - field_nameã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
     */
    function groupByFieldName(data) {
      const grouped = {};
      
      data.forEach(row => {
        const fieldName = row.field_name;
        
        if (!grouped[fieldName]) {
          grouped[fieldName] = [];
        }
        
        grouped[fieldName].push(row);
      });
      
      return grouped;
    }
    
    /**
     * field_nameã”ã¨ã®JSONã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
     * @param {Array} data - ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸCSVãƒ‡ãƒ¼ã‚¿
     * @returns {Object} - field_nameã”ã¨ã®JSON
     */
    function generateFieldNameJson(data) {
      const grouped = groupByFieldName(data);
      const result = {};
      
      for (const fieldName in grouped) {
        const fieldData = grouped[fieldName];
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ã®åŸºæœ¬æƒ…å ±ï¼ˆæœ€åˆã®ã‚¨ãƒ³ãƒˆãƒªã‹ã‚‰å–å¾—ï¼‰
        const fieldDefinition = {
          field_name: fieldName,
          field_type: fieldData[0].field_type,
          field_label: fieldData[0].field_label,
          required: fieldData[0].required,
          placeholder: fieldData[0].placeholder,
          options: fieldData[0].options_json,
          visible_if: fieldData[0].visible_if,
          display_order: parseInt(fieldData[0].display_order) || 999,
          categories: []
        };
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚’æ•´ç†
        const categoryMap = {};
        
        fieldData.forEach(item => {
          // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ¬ãƒ™ãƒ«
          const catKey = item.category_value;
          if (!categoryMap[catKey]) {
            categoryMap[catKey] = {
              value: item.category_value,
              label: item.category_label,
              parents: {}
            };
          }
          
          // è¦ªãƒ¬ãƒ™ãƒ«
          const parentKey = item.parent_value;
          if (parentKey && !categoryMap[catKey].parents[parentKey]) {
            categoryMap[catKey].parents[parentKey] = {
              value: item.parent_value,
              label: item.parent_label,
              children: {}
            };
          }
          
          // å­ãƒ¬ãƒ™ãƒ«
          const childKey = item.child_value;
          if (childKey && parentKey && !categoryMap[catKey].parents[parentKey].children[childKey]) {
            categoryMap[catKey].parents[parentKey].children[childKey] = {
              value: item.child_value,
              label: item.child_label,
              grandchildren: {}
            };
          }
          
          // å­«ãƒ¬ãƒ™ãƒ«
          if (childKey && parentKey && item.grandchild_value) {
            const grandchildKey = item.grandchild_value;
            categoryMap[catKey].parents[parentKey].children[childKey].grandchildren[grandchildKey] = {
              value: item.grandchild_value,
              label: item.grandchild_label
            };
          }
        });
        
        // ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã«å¤‰æ›
        Object.values(categoryMap).forEach(category => {
          const categoryObj = {
            value: category.value,
            label: category.label,
            parents: []
          };
          
          Object.values(category.parents).forEach(parent => {
            const parentObj = {
              value: parent.value,
              label: parent.label,
              children: []
            };
            
            Object.values(parent.children).forEach(child => {
              const childObj = {
                value: child.value,
                label: child.label,
                grandchildren: []
              };
              
              Object.values(child.grandchildren).forEach(grandchild => {
                childObj.grandchildren.push({
                  value: grandchild.value,
                  label: grandchild.label
                });
              });
              
              parentObj.children.push(childObj);
            });
            
            categoryObj.parents.push(parentObj);
          });
          
          fieldDefinition.categories.push(categoryObj);
        });
        
        result[fieldName] = fieldDefinition;
      }
      
      return result;
    }
    
    /**
     * JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
     * @param {Object} jsonData - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹JSONãƒ‡ãƒ¼ã‚¿
     * @param {string} fileName - ãƒ•ã‚¡ã‚¤ãƒ«å
     */
    function downloadJson(jsonData, fileName) {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonData, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", fileName);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }
    
    /**
     * GAS APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
     * @returns {Promise<Object>} - å–å¾—ã—ãŸJSONãƒ‡ãƒ¼ã‚¿
     */
    async function fetchDataFromGAS() {
      const gasApiUrl = document.getElementById('gasApiUrl').value;
      
      if (!gasApiUrl) {
        alert('GAS Web APIã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return null;
      }
      
      try {
        const response = await fetch(gasApiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('GAS APIã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        return null;
      }
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
     * @param {Object} fieldsData - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ãƒ‡ãƒ¼ã‚¿
     */
    function generateIncidentForm(fieldsData) {
      const formContainer = document.getElementById('form-container');
      formContainer.innerHTML = '';
      
      // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’ä½œæˆ
      const form = document.createElement('form');
      form.id = 'incident-form';
      
      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
      const sortedFields = Object.values(fieldsData).sort((a, b) => 
        (a.display_order || 999) - (b.display_order || 999)
      );
      
      // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’ç”Ÿæˆ
      sortedFields.forEach(field => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'form-field';
        
        // ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆ
        const label = document.createElement('label');
        label.htmlFor = field.field_name;
        label.textContent = field.field_label;
        if (field.required) {
          const requiredMark = document.createElement('span');
          requiredMark.className = 'required';
          requiredMark.textContent = ' *';
          label.appendChild(requiredMark);
        }
        fieldDiv.appendChild(label);
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å…¥åŠ›è¦ç´ ã‚’ä½œæˆ
        let inputElement;
        switch (field.field_type) {
          case 'text':
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.id = field.field_name;
            inputElement.name = field.field_name;
            inputElement.placeholder = field.placeholder || '';
            break;
          case 'textarea':
            inputElement = document.createElement('textarea');
            inputElement.id = field.field_name;
            inputElement.name = field.field_name;
            inputElement.placeholder = field.placeholder || '';
            break;
          case 'select':
            inputElement = document.createElement('select');
            inputElement.id = field.field_name;
            inputElement.name = field.field_name;
            
            // ç©ºã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
            inputElement.appendChild(emptyOption);
            
            // é¸æŠè‚¢ã‚’è¿½åŠ 
            if (Array.isArray(field.options)) {
              field.options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                inputElement.appendChild(optionElement);
              });
            }
            break;
          case 'radio':
            inputElement = document.createElement('div');
            inputElement.className = 'radio-group';
            
            if (Array.isArray(field.options)) {
              field.options.forEach((option, index) => {
                const radioDiv = document.createElement('div');
                radioDiv.className = 'radio-option';
                
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `${field.field_name}_${index}`;
                radioInput.name = field.field_name;
                radioInput.value = option;
                
                const radioLabel = document.createElement('label');
                radioLabel.htmlFor = `${field.field_name}_${index}`;
                radioLabel.textContent = option;
                
                radioDiv.appendChild(radioInput);
                radioDiv.appendChild(radioLabel);
                inputElement.appendChild(radioDiv);
              });
            }
            break;
          default:
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.id = field.field_name;
            inputElement.name = field.field_name;
        }
        
        // å¿…é ˆå±æ€§ã‚’è¨­å®š
        if (field.required && inputElement.tagName !== 'DIV') {
          inputElement.required = true;
        }
        
        fieldDiv.appendChild(inputElement);
        form.appendChild(fieldDiv);
      });
      
      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'é€ä¿¡';
      submitBtn.className = 'submit-btn';
      form.appendChild(submitBtn);
      
      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        alert('ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰');
        
        // å®Ÿéš›ã®APIã¨é€£æºã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        /*
        const formData = new FormData(e.target);
        const formDataObj = {};
        
        for (const [key, value] of formData.entries()) {
          formDataObj[key] = value;
        }
        
        const gasApiUrl = document.getElementById('gasApiUrl').value;
        
        if (gasApiUrl) {
          fetch(gasApiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formDataObj)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãŒæ­£å¸¸ã«å ±å‘Šã•ã‚Œã¾ã—ãŸ');
              form.reset();
            } else {
              alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.message);
            }
          })
          .catch(error => {
            console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          });
        }
        */
      });
      
      formContainer.appendChild(form);
    }
    
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayFieldList(fieldNameJson) {
      const fieldList = document.getElementById('fieldList');
      fieldList.innerHTML = '<h3>æ¤œå‡ºã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</h3>';
      
      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
      const sortedFields = Object.values(fieldNameJson).sort((a, b) => 
        (a.display_order || 999) - (b.display_order || 999)
      );
      
      if (sortedFields.length === 0) {
        fieldList.innerHTML += '<p>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        return;
      }
      
      sortedFields.forEach(field => {
        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';
        
        // å¿…é ˆãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
        const requiredMark = field.required ? '<span style="color: red;"> *</span>' : '';
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
        let typeIcon = '';
        switch(field.field_type) {
          case 'text':
            typeIcon = 'ğŸ“';
            break;
          case 'textarea':
            typeIcon = 'ğŸ“„';
            break;
          case 'select':
            typeIcon = 'ğŸ“‹';
            break;
          case 'radio':
            typeIcon = 'âšª';
            break;
          case 'checkbox':
            typeIcon = 'âœ…';
            break;
          default:
            typeIcon = 'ğŸ”¹';
        }
        
        fieldItem.innerHTML = `
          <h4>${typeIcon} ${field.field_label}${requiredMark} (${field.field_name})</h4>
          <p>ã‚¿ã‚¤ãƒ—: ${field.field_type}</p>
          <p>è¡¨ç¤ºé †: ${field.display_order}</p>
          ${field.placeholder ? `<p>ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼: ${field.placeholder}</p>` : ''}
          ${field.options ? `<p>é¸æŠè‚¢: ${JSON.stringify(field.options)}</p>` : ''}
          <p>ã‚«ãƒ†ã‚´ãƒªãƒ¼æ•°: ${field.categories.length}</p>
        `;
        
        fieldList.appendChild(fieldItem);
      });
    }
    
    // CSVãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
    function processCsvData(csvContent) {
      try {
        // CSVã‚’ãƒ‘ãƒ¼ã‚¹
        const parsedData = parseCSV(csvContent);
        
        // field_nameã”ã¨ã«JSONã‚’ç”Ÿæˆ
        const fieldNameJson = generateFieldNameJson(parsedData);
        
        // çµæœã‚’å‡ºåŠ›
        document.getElementById('output').textContent = JSON.stringify(fieldNameJson, null, 2);
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        displayFieldList(fieldNameJson);
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('downloadBtn').onclick = function() {
          downloadJson(fieldNameJson, 'incident_fields.json');
        };
        
        return fieldNameJson;
      } catch (error) {
        document.getElementById('output').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
        console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }
    
    // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // è¦ç´ ã®å‚ç…§ã‚’å–å¾—
      const fileInput = document.getElementById('csvFile');
      const convertBtn = document.getElementById('convertBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const fetchFromGASBtn = document.getElementById('fetchFromGAS');
      const generateFormBtn = document.getElementById('generateForm');
      const outputArea = document.getElementById('output');
      const tabs = document.querySelectorAll('.tab');
      
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
          this.classList.add('active');
          
          // å¯¾å¿œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId + '-tab').classList.add('active');
        });
      });
      
      // å¤‰æ›ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      convertBtn.addEventListener('click', function() {
        if (fileInput.files.length === 0) {
          alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const csvContent = e.target.result;
          processCsvData(csvContent);
        };
        
        reader.readAsText(file);
      });
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      fileInput.addEventListener('change', function() {
        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        convertBtn.disabled = false;
        
        // è‡ªå‹•çš„ã«å¤‰æ›ã‚’é–‹å§‹
        if (this.files.length > 0) {
          convertBtn.click();
        }
      });
      
      // GAS APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      fetchFromGASBtn.addEventListener('click', async function() {
        const loadingMsg = document.createElement('p');
        loadingMsg.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
        loadingMsg.id = 'loading-message';
        
        const loadingIcon = document.createElement('span');
        loadingIcon.className = 'loading';
        loadingMsg.appendChild(loadingIcon);
        
        outputArea.textContent = '';
        outputArea.appendChild(loadingMsg);
        
        const data = await fetchDataFromGAS();
        
        if (data) {
          // çµæœã‚’å‡ºåŠ›
          outputArea.textContent = JSON.stringify(data, null, 2);
          
          // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          displayFieldList(data);
          
          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          downloadBtn.disabled = false;
          downloadBtn.onclick = function() {
            downloadJson(data, 'incident_fields.json');
          };
        } else {
          outputArea.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
      });
      
      // ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      generateFormBtn.addEventListener('click', function() {
        try {
          const jsonText = outputArea.textContent;
          if (!jsonText || jsonText.trim() === '' || jsonText.includes('ã“ã“ã«JSONãŒè¡¨ç¤ºã•ã‚Œã¾ã™')) {
            alert('å…ˆã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›ã™ã‚‹ã‹ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚');
            return;
          }
          
          const jsonData = JSON.parse(jsonText);
          generateIncidentForm(jsonData);
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          document.querySelector('.tab[data-tab="form"]').classList.add('active');
          document.getElementById('form-tab').classList.add('active');
          
        } catch (error) {
          alert('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          console.error('JSONã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        }
      });
    });

    

  </script>
</body>
</html>
